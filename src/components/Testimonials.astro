---
import TestimonialCards from "./TestimonialCards.astro";

let reviews = [];

try {
  const response = await fetch(`${import.meta.env.SITE}/api/reviews`);
  const data = await response.json();
  reviews = data.ok ? (data.reviews || []).slice(0, 15) : [];
} catch (e) {
  console.error("Error fetching reviews:", e);
  reviews = [];
}
---

<section
  id="testimonials"
  class="relative py-12 bg-linear-to-br from-slate-100 via-white to-slate-100 overflow-hidden"
>
  <div class="max-w-5xl mx-auto px-6">
    <div class="text-center mb-12">
      <h2 class="text-4xl md:text-5xl font-extrabold text-slate-900 testimonials-title">
        Opiniones de nuestros clientes
      </h2>
      <p class="mt-4 text-lg text-slate-600 testimonials-subtitle">
        Experiencias reales de personas que confiaron en nuestro servicio
      </p>
    </div>

    <div class="swiper testimonials-swiper">
  <div class="swiper-wrapper">
    {reviews.map((t, index) => (
      <div
        class="swiper-slide h-full flex items-stretch"
        data-hash={`review-${index + 1}`}
      >
        <TestimonialCards
          name={t.name}
          text={t.text}
          rating={t.rating}
          url={t.url}
        />
      </div>
    ))}
  </div>

  <div class="swiper-pagination"></div>
</div>

  </div>
</section>
<script>
  import Swiper from 'swiper';
  import { Pagination, HashNavigation, Autoplay } from 'swiper/modules';
  import { animate, inView } from "motion";

  const swiperContainer = document.querySelector('.testimonials-swiper');
  const title = document.querySelector('.testimonials-title');
  const subtitle = document.querySelector('.testimonials-subtitle');

  const swiper = new Swiper('.swiper', {
    modules: [Pagination, HashNavigation, Autoplay],
    loop: true,
    spaceBetween: 24,

    slidesPerView: 1,
    breakpoints: {
      768: {
        slidesPerView: 2,
      },
      1024: {
        slidesPerView: 3,
      },
    },

    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },

    hashNavigation: {
      watchState: true,
    },

    autoplay: {
      delay: 5000,
      disableOnInteraction: false,
    },
  });

  inView(".testimonials-title", () => {
    if(title) animate(title, { opacity: [0, 1], y: [20, 0] }, { duration: 0.5, easing: "ease-in" });
    if(subtitle) animate(subtitle, { opacity: [0, 1], y: [16, 0] }, { duration: 0.5, easing: "ease-in" });
    if(swiperContainer) animate(swiperContainer, { opacity: [0, 1], y: [-30, 0], scale: [0.95, 1] }, { duration: 0.6, easing: "ease-in", delay: 0.4 });
  });

</script>
<link
  rel="preload"
  as="style"
  href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
  onload="this.rel='stylesheet'"
/>